<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Saniel Finance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        // ==========================================
        // 1. å®‰å…¨èˆ‡ API é…ç½®
        // ==========================================
        const APP_PASSWORD = "0825"; 
        const API_URL = "https://script.google.com/macros/s/AKfycbw7R8QEYDu4XHMSPqGl7vfwLA8QL1cursdlSLQ9ps3XDrjson1b8JZp3FP1i6Kz-oQ/exec";

        function checkAccess() {
            let savedPass = localStorage.getItem('family_app_auth');
            if (savedPass === APP_PASSWORD) return true;
            while (savedPass !== APP_PASSWORD) {
                savedPass = prompt("ğŸ” è«‹è¼¸å…¥å®¶åº­å¯†ç¢¼ï¼š");
                if (savedPass === null) {
                    document.body.innerHTML = "<div class='flex h-screen items-center justify-center text-gray-500'>å­˜å–è¢«æ‹’çµ•</div>";
                    return false;
                }
                if (savedPass === APP_PASSWORD) localStorage.setItem('family_app_auth', savedPass);
                else alert("âŒ å¯†ç¢¼éŒ¯èª¤");
            }
            return true;
        }

        tailwind.config = {
            theme: {
                extend: { colors: { brand: { light: '#818cf8', DEFAULT: '#4f46e5', dark: '#3730a3' } }, padding: { 'safe': 'env(safe-area-inset-bottom)' } }
            }
        }
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .app-container { max-width: 480px; margin: 0 auto; background-color: #ffffff; min-height: 100vh; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.08); padding-bottom: calc(90px + env(safe-area-inset-bottom)); }
        .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        
        /* ä¿®æ­£ iPhone è¼¸å…¥æ¡†ç‰ˆé¢å•é¡Œï¼šåŠ å…¥ max-width: 100% */
        .input-style { background-color: #f9fafb; border: 1px solid #e5e7eb; transition: all 0.2s; width: 100%; max-width: 100%; }
        .input-style:focus { border-color: #6366f1; background-color: #fff; outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        .modal { transition: opacity 0.2s ease; opacity: 0; pointer-events: none; z-index: 100; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { transform: translateY(20px); transition: transform 0.2s ease; }
        .modal.active .modal-content { transform: translateY(0); }
        
        #initial-loading { position: fixed; inset: 0; z-index: 9999; display: flex; justify-content: center; items-center; background: #fff; transition: opacity 0.3s; }
        #initial-loading.hidden { opacity: 0; pointer-events: none; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @keyframes pulse-yellow { 0%, 100% { color: #eab308; opacity: 1; } 50% { opacity: 0.5; } }
        .sync-saving { animation: pulse-yellow 1.5s infinite; }
        .sync-done { color: #10b981; transition: color 0.5s; }
        .sync-error { color: #ef4444; }

        .suggestion-box { position: absolute; background: white; border: 1px solid #e5e7eb; width: 100%; z-index: 40; border-radius: 0.5rem; max-height: 150px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body onload="if(checkAccess()) initApp();" ontouchstart=""> 
<div id="initial-loading">
    <div class="text-center">
        <div class="spinner mx-auto mb-3"></div>
        <p class="text-gray-500 text-sm font-medium">è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>
</div>

<div class="app-container hide-scrollbar" id="app">
    
    <div id="top-nav-bar" class="fixed top-0 max-w-[480px] w-full z-20 flex justify-between items-center px-4 py-3 pointer-events-none transition-opacity duration-200 bg-white/80 backdrop-blur-md border-b border-gray-100">
        <div class="pointer-events-auto flex items-center gap-2">
            <button onclick="openBackup()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center transition active:scale-95">
                <i id="sync-icon" class="fas fa-cloud text-gray-400 text-sm"></i>
            </button>
            <span id="sync-text" class="text-[10px] text-gray-400 font-medium">å·²åŒæ­¥</span>
        </div>
        
        <div class="pointer-events-auto flex items-center gap-2">
            <button onclick="manualRefresh()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:text-indigo-600 transition active:scale-95" title="åˆ·æ–°è³‡æ–™">
                <i class="fas fa-sync-alt text-sm"></i>
            </button>
            <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:text-indigo-600 transition active:scale-95">
                <i class="fas fa-cog text-sm"></i>
            </button>
        </div>
    </div>

    <div id="view-home" class="view-section pt-16">
        <div class="gradient-bg text-white pt-6 pb-8 px-6 rounded-b-[2rem] shadow-lg mb-4 relative overflow-hidden mx-2 mt-2">
            <div class="text-center relative z-10">
                <p class="text-xs opacity-80 mb-1" id="home-title">æœ¬æœŸç¯©é¸ç¸½æ”¯å‡º</p>
                <div class="flex justify-center items-end gap-1">
                    <span class="text-lg opacity-80 mb-2">Â£</span>
                    <h2 class="text-5xl font-bold tracking-tight" id="home-total-gbp">0</h2>
                </div>
                <div class="mt-2 text-xs opacity-80 bg-white/20 inline-block px-3 py-1 rounded-full">
                    HK$ <span id="home-total-hkd">0</span>
                </div>
                <div id="member-stats" class="hidden mt-4 bg-white/10 rounded-xl p-3 text-xs flex justify-around"></div>
            </div>
        </div>

        <div class="px-4 mb-2 flex items-center justify-between">
            <h3 class="text-gray-800 font-bold text-lg">æ¶ˆè²»æ˜ç´°</h3>
            <button onclick="openFilterModal()" class="bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 active:scale-95 transition">
                <i class="fas fa-filter"></i> ç¯©é¸
                <div id="filter-dot" class="hidden w-1.5 h-1.5 bg-red-500 rounded-full ml-1"></div>
            </button>
        </div>
        
        <div id="active-filters-bar" class="px-4 mb-3 flex flex-wrap gap-2"></div>
        <div class="px-4">
            <div id="expense-list" class="space-y-3 pb-24"></div>
        </div>
    </div>

    <div id="view-add" class="view-section hidden px-5 pt-6 min-h-screen bg-white relative z-30 pb-20">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800" id="form-title">æ–°å¢æ¶ˆè²»</h2>
            <button onclick="switchView('home')" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 transition active:bg-gray-200"><i class="fas fa-times"></i></button>
        </div>
        
        <form id="expense-form" onsubmit="handleFormSubmit(event)">
            <input type="hidden" id="edit-id">
            
            <div class="flex gap-3 mb-5">
                <div class="w-1/3">
                    <label class="block text-xs font-bold text-gray-400 mb-1">è²¨å¹£</label>
                    <select id="currency" class="input-style px-2 py-3 rounded-xl text-lg font-bold text-gray-700 bg-white text-center h-[54px]">
                        <option value="GBP">Â£ GBP</option>
                        <option value="HKD">HK$</option>
                    </select>
                </div>
                <div class="w-2/3">
                    <label class="block text-xs font-bold text-gray-400 mb-1">é‡‘é¡</label>
                    <input type="number" step="0.01" id="amount" required class="input-style px-4 py-3 rounded-xl text-2xl font-bold text-gray-800 text-right h-[54px]" placeholder="0.00" oninput="updateSplitInputs()">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="min-w-0">
                    <label class="block text-xs font-bold text-gray-400 mb-1">æ—¥æœŸ</label>
                    <input type="date" id="date" required class="input-style w-full px-3 py-3 rounded-xl text-gray-700 text-sm bg-white h-[46px] appearance-none">
                </div>
                <div class="min-w-0">
                    <label class="block text-xs font-bold text-gray-400 mb-1">æ”¯ä»˜æ–¹å¼</label>
                    <div class="relative">
                         <select id="payment-method" class="input-style px-3 py-3 rounded-xl text-gray-700 bg-white text-sm appearance-none h-[46px] pr-8 truncate"></select>
                         <div class="absolute right-3 top-3.5 pointer-events-none text-gray-400 text-xs"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="relative min-w-0">
                    <label class="block text-xs font-bold text-gray-400 mb-1">é¡åˆ¥</label>
                    <select id="category" class="input-style px-3 py-3 rounded-xl text-gray-700 bg-white appearance-none text-sm h-[46px] pr-8 truncate"></select>
                    <div class="absolute right-3 top-8 pointer-events-none text-gray-400 text-xs"><i class="fas fa-chevron-down"></i></div>
                </div>
                <div class="relative min-w-0">
                    <label class="block text-xs font-bold text-gray-400 mb-1">å•†æˆ¶</label>
                    <input type="text" id="merchant" autocomplete="off" class="input-style px-3 py-3 rounded-xl text-gray-700 text-sm h-[46px]" placeholder="ä¾‹å¦‚: Tesco" oninput="handleMerchantInput(this)">
                    <div id="merchant-suggestions" class="suggestion-box hidden top-[70px]"></div>
                </div>
            </div>

            <div class="mb-5">
                <label class="block text-xs font-bold text-gray-400 mb-1">å‚™è¨»</label>
                <input type="text" id="remark" class="input-style px-4 py-3 rounded-xl text-gray-700 text-sm" placeholder="é¸å¡«...">
            </div>

            <div class="mb-5">
                <label class="block text-xs font-bold text-gray-400 mb-2">èª°å…ˆä»˜çš„éŒ¢ï¼Ÿ</label>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar" id="payer-container"></div>
            </div>

            <div class="mb-8 bg-gray-50 p-4 rounded-xl border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-xs font-bold text-gray-500">åˆ†å¸³æ–¹å¼</label>
                    <div class="flex bg-white rounded-lg p-1 border border-gray-200 shadow-sm">
                        <button type="button" onclick="setSplitMode('equal')" id="btn-split-equal" class="px-3 py-1 text-xs rounded font-bold bg-indigo-500 text-white transition">å¹³åˆ†</button>
                        <button type="button" onclick="setSplitMode('custom')" id="btn-split-custom" class="px-3 py-1 text-xs rounded font-bold text-gray-500 transition">è‡ªå®šç¾©</button>
                    </div>
                </div>
                <div id="consumer-container" class="space-y-2"></div>
                <div id="custom-split-warning" class="hidden mt-2 text-xs text-red-500 text-right font-bold">é‡‘é¡ä¸ç¬¦: <span id="custom-sum-diff">0</span></div>
            </div>

            <button type="submit" class="w-full gradient-bg text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transform active:scale-[0.98] transition mb-4"><i class="fas fa-check mr-2"></i> <span id="submit-btn-text">å„²å­˜ç´€éŒ„</span></button>
            <button type="button" onclick="deleteCurrentExpense()" id="btn-delete-expense" class="hidden w-full bg-red-50 text-red-500 font-bold py-3 rounded-xl border border-red-100 mb-8">åˆªé™¤æ­¤ç´€éŒ„</button>
        </form>
    </div>

    <div id="view-split" class="view-section hidden px-4 pt-20 pb-20 relative z-30 bg-white min-h-screen">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 px-1">å¸³å‹™çµç®—</h2>
        <div class="flex p-1 bg-gray-100 rounded-xl mb-6">
            <button onclick="setSplitCurrency('GBP')" id="tab-gbp" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-indigo-600">GBP (Â£)</button>
            <button onclick="setSplitCurrency('HKD')" id="tab-hkd" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700">HKD ($)</button>
        </div>
        <div id="settlement-list" class="space-y-3 mb-8"></div>
        <div>
            <h3 class="text-gray-700 font-bold text-lg mb-3"><i class="fas fa-history text-gray-400 text-sm mr-1"></i> æ­·å²çµç®—</h3>
            <div id="history-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="modal-filter" class="modal fixed inset-0 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm z-50">
        <div class="modal-content bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 sticky top-0 z-10">
                <h3 class="font-bold text-gray-800">ç¯©é¸æ¢ä»¶</h3>
                <button onclick="closeFilterModal()" class="text-gray-400 w-8 h-8 flex items-center justify-center rounded-full bg-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-6">
                <div><label class="text-xs font-bold text-gray-400 block mb-2">æ—¥æœŸç¯„åœ</label><div class="flex gap-2"><input type="date" id="filter-start" class="input-style w-full p-2 rounded-lg text-sm"><input type="date" id="filter-end" class="input-style w-full p-2 rounded-lg text-sm"></div></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-400 block mb-2">ç‹€æ…‹</label><select id="filter-status" class="input-style w-full p-2 rounded-lg text-sm bg-white"><option value="unsettled">æœªçµç®—</option><option value="settled">å·²çµç®—</option><option value="all">å…¨éƒ¨</option></select></div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-2">è²¨å¹£</label><select id="filter-currency" class="input-style w-full p-2 rounded-lg text-sm bg-white"><option value="all">å…¨éƒ¨</option><option value="GBP">GBP</option><option value="HKD">HKD</option></select></div>
                </div>
                <div><label class="text-xs font-bold text-gray-400 block mb-2">æˆå“¡</label><select id="filter-member-select" class="input-style w-full p-2 rounded-lg text-sm bg-white"></select></div>
                <div><label class="text-xs font-bold text-gray-400 block mb-2">é¡åˆ¥</label><div id="filter-categories" class="grid grid-cols-3 gap-2"></div></div>
            </div>
            <div class="p-4 border-t border-gray-100 flex gap-3 bg-white sticky bottom-0 safe-pb">
                <button onclick="resetFilters()" class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold">é‡ç½®</button>
                <button onclick="applyFilters()" class="flex-1 py-3 rounded-xl gradient-bg text-white font-bold shadow-lg">å¥—ç”¨</button>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="modal fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 z-50">
        <div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden max-h-[85vh] flex flex-col">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-800">è¨­å®š</h3>
                <button onclick="closeSettings()" class="text-gray-400 w-8 h-8 rounded-full bg-white flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="overflow-y-auto p-5 space-y-6 hide-scrollbar">
                <div>
                    <h4 class="text-xs font-bold text-indigo-500 mb-2 uppercase tracking-wider">æˆå“¡ç®¡ç†</h4>
                    <div id="settings-members" class="space-y-2 mb-2"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-member-name" placeholder="æ–°æˆå“¡" class="input-style flex-1 px-3 py-2 rounded-lg text-sm min-w-0">
                        <button onclick="addMember()" class="bg-indigo-500 text-white w-10 h-10 shrink-0 rounded-lg flex items-center justify-center"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-indigo-500 mb-2 uppercase tracking-wider">æ”¯ä»˜æ–¹å¼</h4>
                    <div id="settings-methods" class="space-y-2 mb-2"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-method-name" placeholder="æ–¹å¼åç¨±" class="input-style flex-1 px-3 py-2 rounded-lg text-sm min-w-0">
                        <button onclick="addPaymentMethod()" class="bg-indigo-500 text-white w-10 h-10 shrink-0 rounded-lg flex items-center justify-center"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-indigo-500 mb-2 uppercase tracking-wider">æ¶ˆè²»é¡åˆ¥</h4>
                    <div id="settings-categories" class="space-y-2 mb-2"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-cat-icon" placeholder="ğŸ·ï¸" class="input-style w-10 text-center px-1 py-2 rounded-lg text-sm shrink-0">
                        <input type="text" id="new-cat-name" placeholder="é¡åˆ¥å" class="input-style flex-1 px-3 py-2 rounded-lg text-sm min-w-0">
                        <button onclick="addCategory()" class="bg-indigo-500 text-white w-10 h-10 shrink-0 rounded-lg flex items-center justify-center"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-100">
                    <button onclick="clearAllData()" class="w-full text-red-400 text-xs py-2 hover:text-red-600">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-backup" class="modal fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 z-50">
        <div class="modal-content bg-white w-full max-w-xs rounded-2xl p-6 text-center">
            <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-500 text-2xl"><i class="fas fa-cloud-sync-alt"></i></div>
            <h3 class="text-xl font-bold mb-2">é›²ç«¯ç‹€æ…‹</h3>
            <p class="text-gray-500 text-sm mb-6">è³‡æ–™æœƒè‡ªå‹•åœ¨èƒŒæ™¯åŒæ­¥ã€‚<br>æ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•å¼·åˆ¶åŸ·è¡Œã€‚</p>
            <button onclick="triggerBackup()" class="w-full gradient-bg text-white font-bold py-3 rounded-xl mb-3 shadow-md active:scale-95 transition">ç«‹å³å¼·åˆ¶å‚™ä»½</button>
            <button onclick="triggerRestore()" class="w-full bg-white border border-gray-200 text-gray-700 font-bold py-3 rounded-xl active:bg-gray-50 transition">å¾é›²ç«¯é‚„åŸ</button>
            <button onclick="document.getElementById('modal-backup').classList.remove('active')" class="mt-4 text-gray-400 text-sm">é—œé–‰</button>
        </div>
    </div>
    
    <div id="modal-settlement-detail" class="modal fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 z-50">
         <div class="modal-content bg-white w-full sm:max-w-md rounded-2xl shadow-2xl h-[70vh] flex flex-col relative" id="settlement-detail-content"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-6 py-2 flex justify-between items-end max-w-[480px] mx-auto z-40 pb-safe">
        <button onclick="switchView('home')" class="nav-btn active flex flex-col items-center gap-1 w-1/3 text-indigo-600 pb-2 transition duration-200"><i class="fas fa-list-ul text-xl"></i><span class="text-[10px] font-medium">æ˜ç´°</span></button>
        <div class="relative -top-5">
            <button onclick="switchView('add')" class="h-14 w-14 rounded-full gradient-bg text-white shadow-xl shadow-indigo-200 flex items-center justify-center transform hover:scale-105 active:scale-95 transition duration-200">
                <i class="fas fa-plus text-2xl"></i>
            </button>
        </div>
        <button onclick="switchView('split')" class="nav-btn flex flex-col items-center gap-1 w-1/3 text-gray-400 hover:text-indigo-500 transition pb-2"><i class="fas fa-hand-holding-usd text-xl"></i><span class="text-[10px] font-medium">çµç®—</span></button>
    </div>
</div>

<script>
    // --- App State ---
    let STATE = {
        members: ['çˆ¸çˆ¸', 'åª½åª½', 'å…’å­'],
        categories: [],
        methods: [],
        expenses: [],
        settlements: [],
        filters: { start: '', end: '', status: 'unsettled', currency: 'all', member: '', categories: [] },
        splitMode: 'equal',
        splitCurrency: 'GBP'
    };
    
    function setSyncStatus(status) {
        const icon = document.getElementById('sync-icon');
        const text = document.getElementById('sync-text');
        icon.className = "fas fa-cloud text-sm transition-colors duration-300"; 
        if (status === 'saving') {
            icon.classList.add('text-yellow-500', 'sync-saving');
            text.innerText = "åŒæ­¥ä¸­...";
            text.className = "text-[10px] text-yellow-500 font-medium";
        } else if (status === 'done') {
            icon.classList.add('text-green-500');
            icon.classList.remove('sync-saving');
            text.innerText = "å·²åŒæ­¥";
            text.className = "text-[10px] text-green-500 font-medium";
            setTimeout(() => { icon.classList.replace('text-green-500', 'text-gray-400'); text.className = "text-[10px] text-gray-400 font-medium"; }, 3000);
        } else if (status === 'error') {
            icon.classList.add('text-red-500');
            icon.classList.remove('sync-saving');
            text.innerText = "å¤±æ•—";
            text.className = "text-[10px] text-red-500 font-medium";
        }
    }

    async function initApp() {
        await loadRemoteData();
        document.getElementById('initial-loading').classList.add('hidden');
    }
    
    // æ–°å¢ï¼šæ‰‹å‹•åˆ·æ–°åŠŸèƒ½
    async function manualRefresh() {
        const btn = document.querySelector('button[title="åˆ·æ–°è³‡æ–™"] i');
        btn.classList.add('fa-spin'); // è®“åœ–æ¨™æ—‹è½‰
        setSyncStatus('saving');
        await loadRemoteData();
        btn.classList.remove('fa-spin');
        setSyncStatus('done');
    }

    async function loadRemoteData() {
        try {
            const res = await fetch(API_URL + "?t=" + new Date().getTime());
            const data = await res.json();
            
            if (data.status === 'error') throw new Error(data.message);
            
            STATE.members = (data.members && data.members.length > 0) ? data.members : STATE.members;
            STATE.categories = data.categories || [];
            STATE.methods = data.methods || ['ç¾é‡‘'];
            
            // --- æ ¸å¿ƒä¿®æ­£é–‹å§‹ ---
            // å¼·åˆ¶å°‡æ‰€æœ‰ ID è½‰ç‚ºå­—ä¸²ï¼Œä¸¦ä¿®æ­£æ—¥æœŸæ ¼å¼
            STATE.expenses = (data.expenses || []).map(e => {
                if (e.id !== undefined && e.id !== null) {
                    e.id = String(e.id); // å¼·åˆ¶è½‰ç‚ºå­—ä¸²
                }
                // è™•ç† Google Sheet å¯èƒ½å›å‚³çš„ ISO æ—¥æœŸå­—ä¸² (å« T)
                if (e.date && typeof e.date === 'string' && e.date.includes('T')) {
                    e.date = e.date.split('T')[0];
                }
                return e;
            });

            STATE.settlements = (data.settlements || []).map(s => {
                if (s.id !== undefined && s.id !== null) {
                    s.id = String(s.id); // å¼·åˆ¶è½‰ç‚ºå­—ä¸²
                }
                if (s.date && typeof s.date === 'string' && s.date.includes('T')) {
                    s.date = s.date.split('T')[0];
                }
                return s;
            });
            // --- æ ¸å¿ƒä¿®æ­£çµæŸ ---

            initUI();
            renderHome();
        } catch (e) {
            console.error(e);
            alert("âš ï¸ è³‡æ–™åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚\néŒ¯èª¤ï¼š" + e.message);
            setSyncStatus('error');
        }
    }

    async function saveRemoteData(action = 'save') {
        setSyncStatus('saving');
        const payload = { action: action, payload: { members: STATE.members, categories: STATE.categories, methods: STATE.methods, expenses: STATE.expenses, settlements: STATE.settlements } };
        try {
            const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
            const data = await res.json();
            if (data.status === 'error') throw new Error(data.message);
            setSyncStatus('done');
            if (action === 'backup') alert("âœ… å¼·åˆ¶å‚™ä»½æˆåŠŸï¼");
        } catch (e) {
            console.error(e); setSyncStatus('error');
            if (action === 'backup') alert("å‚™ä»½å¤±æ•—ï¼š" + e.message);
        }
    }

    async function triggerBackup() { await saveRemoteData('backup'); document.getElementById('modal-backup').classList.remove('active'); }
    async function triggerRestore() {
        if(!confirm("ç¢ºå®šå¾é›²ç«¯é‚„åŸï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„é¡¯ç¤ºè³‡æ–™ã€‚")) return;
        document.getElementById('initial-loading').classList.remove('hidden');
        await loadRemoteData(); // é‡ç”¨ loadRemoteData å³å¯
        document.getElementById('modal-backup').classList.remove('active');
        document.getElementById('initial-loading').classList.add('hidden');
        alert("âœ… é‚„åŸæˆåŠŸï¼");
    }

    function initUI() { document.getElementById('date').valueAsDate = new Date(); }
    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active', 'text-indigo-600'); b.classList.add('text-gray-400'); });
        const topNav = document.getElementById('top-nav-bar');
        if (view === 'home') {
            document.querySelectorAll('.nav-btn')[0].classList.add('active', 'text-indigo-600');
            document.querySelectorAll('.nav-btn')[0].classList.remove('text-gray-400');
            topNav.classList.remove('opacity-0', 'pointer-events-none'); renderHome();
        } else {
            topNav.classList.add('opacity-0', 'pointer-events-none');
            if (view === 'split') {
                document.querySelectorAll('.nav-btn')[1].classList.add('active', 'text-indigo-600');
                document.querySelectorAll('.nav-btn')[1].classList.remove('text-gray-400');
                renderSplit();
            } else if (view === 'add') { if (!document.getElementById('edit-id').value) resetForm(); }
        }
    }

    function renderHome() {
        const filtered = getFilteredExpenses();
        const listEl = document.getElementById('expense-list');
        listEl.innerHTML = '';
        const targetMember = STATE.filters.member;
        let totalDisplay = 0, totalDisplayHKD = 0;
        let memTotalVol = 0, memActualCost = 0;
        
        // æ’åºæ”¹é€²ï¼šç¢ºä¿æ—¥æœŸæ ¼å¼çµ±ä¸€å¾Œçš„æ’åºæ­£ç¢º
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (filtered.length === 0) listEl.innerHTML = `<div class="text-center py-10 text-gray-400 opacity-50"><i class="fas fa-search text-4xl mb-2"></i><p>ç„¡ç¬¦åˆç´€éŒ„</p></div>`;
        else {
            filtered.forEach(exp => {
                let displayAmount = exp.amount;
                let isMyPart = true;
                if (targetMember) {
                    if (Object.keys(exp.splitDetails).length > 0) displayAmount = exp.splitDetails[targetMember] || 0;
                    else if (exp.consumers.includes(targetMember)) displayAmount = exp.amount / exp.consumers.length;
                    else { displayAmount = 0; isMyPart = false; }
                    if (exp.currency === 'GBP') { if (isMyPart) memTotalVol += exp.amount; memActualCost += displayAmount; }
                }
                if (exp.currency === 'GBP') totalDisplay += displayAmount; else totalDisplayHKD += displayAmount;
                const cat = STATE.categories.find(c => c.id === exp.category) || (STATE.categories[0] || {icon:'?',label:'æœªåˆ†é¡',color:''});
                const status = getExpenseStatus(exp);
                let statusHtml = status === 'settled' ? `<span class="bg-green-100 text-green-600 px-1 rounded text-[10px]">å·²çµæ¸…</span>` : (status === 'partial' ? `<span class="bg-blue-50 text-blue-600 px-1 rounded text-[10px]">éƒ¨åˆ†</span>` : '');
                let descTxt = targetMember ? `ç¸½é¡: ${exp.currency==='GBP'?'Â£':'$'}${exp.amount.toLocaleString()} (${exp.payer}ä»˜)` : `${exp.payer} ä»˜ Â· ${exp.consumers.length===STATE.members.length?'å…¨å®¶':exp.consumers.join(', ')}`;
                
                // ä¿®æ­£ï¼šæ—¥æœŸé¡¯ç¤ºä¸å†ä¾è³´ substring(5)ï¼Œæ”¹ç‚ºæ›´å®‰å…¨çš„é¡¯ç¤ºæ–¹å¼
                const displayDate = exp.date.substring(5); // å› ç‚ºæˆ‘å€‘åœ¨ loadRemoteData å·²ç¶“çµ±ä¸€äº†æ ¼å¼ï¼Œé€™è£¡å¯ä»¥å®‰å…¨ä½¿ç”¨

                const itemDiv = document.createElement('div');
                itemDiv.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-50 flex justify-between items-start cursor-pointer active:scale-[0.98] transition duration-200 select-none";
                itemDiv.onclick = function() { editExpense(exp.id); };
                itemDiv.innerHTML = `
                    <div class="flex items-start gap-3 overflow-hidden pointer-events-none">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl shrink-0 mt-1">${cat.icon}</div>
                        <div class="min-w-0">
                            <div class="font-bold text-gray-800 truncate">${exp.merchant || cat.label}</div>
                            <div class="text-xs text-gray-500 truncate mt-0.5">${displayDate} Â· ${descTxt}</div>
                            ${exp.remark ? `<div class="text-[10px] text-gray-400 mt-0.5 truncate"><i class="fas fa-comment-dots mr-1"></i>${exp.remark}</div>` : ''}
                        </div>
                    </div>
                    <div class="text-right shrink-0 pointer-events-none">
                        <div class="font-bold ${exp.currency==='HKD'?'text-pink-600':'text-indigo-600'} text-lg">${exp.currency==='GBP'?'Â£':'$'}${displayAmount.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 1})}</div>
                        <div class="mt-1">${statusHtml}</div>
                    </div>`;
                listEl.appendChild(itemDiv);
            });
        }
        document.getElementById('home-total-gbp').innerText = totalDisplay.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 1});
        document.getElementById('home-total-hkd').innerText = totalDisplayHKD.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 1});
        
        const statsEl = document.getElementById('member-stats');
        if (targetMember) {
            document.getElementById('home-title').innerText = `${targetMember} çš„æ‡‰ä»˜ç¸½é¡`;
            statsEl.classList.remove('hidden');
            statsEl.innerHTML = `<div class="text-center"><div class="text-xs text-indigo-200">åƒèˆ‡æ¶ˆè²»</div><div class="font-bold text-lg">Â£${memTotalVol.toFixed(1)}</div></div><div class="w-px bg-white/20"></div><div class="text-center"><div class="text-xs text-indigo-200">æ‡‰ä»˜</div><div class="font-bold text-lg text-yellow-300">Â£${memActualCost.toFixed(1)}</div></div>`;
        } else {
            document.getElementById('home-title').innerText = "æœ¬æœŸç¯©é¸ç¸½æ”¯å‡º";
            statsEl.classList.add('hidden');
        }
        
        const hasFilter = STATE.filters.start || STATE.filters.status !== 'unsettled' || STATE.filters.member;
        document.getElementById('filter-dot').classList.toggle('hidden', !hasFilter);
        const bar = document.getElementById('active-filters-bar');
        bar.innerHTML = '';
        if (STATE.filters.member) bar.innerHTML += `<span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full font-bold">ğŸ‘¤ ${STATE.filters.member}</span>`;
        if (STATE.filters.categories.length > 0) bar.innerHTML += `<span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full">æŒ‡å®šé¡åˆ¥</span>`;
        if (STATE.filters.status !== 'unsettled') bar.innerHTML += `<span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full">${STATE.filters.status==='settled'?'å·²çµç®—':'å…¨éƒ¨'}</span>`;
    }

    function getExpenseStatus(exp) {
        let totalDebt = 0;
        let debtors = STATE.members.filter(m => m !== exp.payer);
        debtors.forEach(d => {
            let debt = 0;
            if (Object.keys(exp.splitDetails).length > 0) debt = exp.splitDetails[d] || 0;
            else if (exp.consumers.includes(d)) debt = exp.amount / exp.consumers.length;
            totalDebt += debt;
        });
        if (totalDebt < 0.05) return 'settled';
        const totalRepaid = exp.repayments.reduce((sum, r) => sum + r.amount, 0);
        if (totalRepaid >= (totalDebt - 0.05)) return 'settled';
        if (totalRepaid > 0.05) return 'partial';
        return 'unsettled';
    }

    function getFilteredExpenses() {
        const f = STATE.filters;
        return STATE.expenses.filter(e => {
            if (f.start && e.date < f.start) return false;
            if (f.end && e.date > f.end) return false;
            const status = getExpenseStatus(e);
            if (f.status === 'unsettled' && status === 'settled') return false;
            if (f.status === 'settled' && status !== 'settled') return false;
            if (f.currency !== 'all' && e.currency !== f.currency) return false;
            if (f.categories.length > 0 && !f.categories.includes(e.category)) return false;
            if (f.member) {
                const involved = e.payer === f.member || e.consumers.includes(f.member) || (e.splitDetails && e.splitDetails[f.member] > 0);
                if (!involved) return false;
            }
            return true;
        });
    }

    function resetForm() {
        document.getElementById('expense-form').reset();
        document.getElementById('edit-id').value = '';
        document.getElementById('form-title').innerText = 'æ–°å¢æ¶ˆè²»';
        document.getElementById('btn-delete-expense').classList.add('hidden');
        document.getElementById('submit-btn-text').innerText = 'å„²å­˜ç´€éŒ„';
        document.getElementById('date').valueAsDate = new Date();
        setSplitMode('equal');
        renderDropdowns();
    }

    function renderDropdowns() {
        const cats = STATE.categories.length > 0 ? STATE.categories : [{id:'none',label:'æœªåˆ†é¡',icon:'?'}];
        document.getElementById('category').innerHTML = cats.map(c => `<option value="${c.id}">${c.icon} ${c.label}</option>`).join('');
        document.getElementById('payment-method').innerHTML = STATE.methods.map(m => `<option value="${m}">${m}</option>`).join('');
        document.getElementById('payer-container').innerHTML = STATE.members.map((m, i) => `<label class="cursor-pointer shrink-0"><input type="radio" name="payer" value="${m}" class="peer hidden" ${i===0?'checked':''}><div class="px-4 py-2 rounded-full border border-gray-200 text-sm text-gray-600 whitespace-nowrap peer-checked:bg-indigo-500 peer-checked:text-white transition">${m}</div></label>`).join('');
        renderConsumerInputs();
    }

    function setSplitMode(mode) {
        STATE.splitMode = mode;
        const btnEq = document.getElementById('btn-split-equal');
        const btnCu = document.getElementById('btn-split-custom');
        if (mode === 'equal') {
            btnEq.className = 'px-3 py-1 text-xs rounded font-bold bg-indigo-500 text-white transition';
            btnCu.className = 'px-3 py-1 text-xs rounded font-bold text-gray-500 transition';
            document.getElementById('custom-split-warning').classList.add('hidden');
        } else {
            btnCu.className = 'px-3 py-1 text-xs rounded font-bold bg-indigo-500 text-white transition';
            btnEq.className = 'px-3 py-1 text-xs rounded font-bold text-gray-500 transition';
        }
        renderConsumerInputs();
    }

    function renderConsumerInputs() {
        const container = document.getElementById('consumer-container');
        if (STATE.splitMode === 'equal') {
            container.innerHTML = `<div class="grid grid-cols-3 gap-2">` + STATE.members.map(m => `<label class="cursor-pointer"><input type="checkbox" name="consumer_cb" value="${m}" class="peer hidden" checked onchange="updateSplitInputs()"><div class="px-2 py-3 rounded-xl border border-gray-200 text-center text-sm text-gray-600 transition font-medium peer-checked:bg-indigo-50 peer-checked:border-indigo-300 peer-checked:text-indigo-600 truncate">${m}</div></label>`).join('') + `</div>`;
        } else {
            container.innerHTML = STATE.members.map(m => `<div class="flex items-center justify-between bg-white border border-gray-200 p-2 rounded-lg"><span class="text-sm font-bold text-gray-700 ml-2 truncate">${m}</span><div class="relative w-1/2 shrink-0"><span class="absolute left-2 top-2 text-gray-400 text-xs">$</span><input type="number" step="0.01" data-member="${m}" class="custom-split-input w-full bg-gray-50 rounded p-1 pl-5 text-right font-bold text-gray-800 focus:outline-none focus:ring-1 ring-indigo-500" placeholder="0" oninput="validateCustomSplit()"></div></div>`).join('');
            validateCustomSplit();
        }
    }

    function updateSplitInputs() { if (STATE.splitMode === 'custom') validateCustomSplit(); }
    function validateCustomSplit() {
        const total = parseFloat(document.getElementById('amount').value) || 0;
        let sum = 0;
        document.querySelectorAll('.custom-split-input').forEach(inp => sum += parseFloat(inp.value) || 0);
        const diff = total - sum;
        const warnEl = document.getElementById('custom-split-warning');
        document.getElementById('custom-sum-diff').innerText = diff.toFixed(2);
        if (Math.abs(diff) > 0.05) { warnEl.classList.remove('hidden'); return false; } else { warnEl.classList.add('hidden'); return true; }
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('amount').value);
        if (!amount) return alert("è«‹è¼¸å…¥é‡‘é¡");
        
        // (çœç•¥ä¸­é–“çš„åˆ†å¸³è¨ˆç®—é‚è¼¯ï¼Œä¿æŒæ‚¨åŸæœ¬çš„ä»£ç¢¼ä¸è®Š...)
        let consumers = [], splitDetails = {};
        if (STATE.splitMode === 'equal') {
            const cbs = document.querySelectorAll('input[name="consumer_cb"]:checked');
            consumers = Array.from(cbs).map(cb => cb.value);
            if (consumers.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€äººåˆ†å¸³");
        } else {
            if (!validateCustomSplit()) return alert("åˆ†å¸³é‡‘é¡ç¸½å’Œä¸ç­‰æ–¼æ¶ˆè²»é‡‘é¡ï¼");
            document.querySelectorAll('.custom-split-input').forEach(inp => {
                const val = parseFloat(inp.value) || 0;
                const mem = inp.dataset.member;
                splitDetails[mem] = val;
                consumers.push(mem);
            });
        }
        // (çœç•¥çµæŸ)

        // --- æ ¸å¿ƒä¿®æ­£é–‹å§‹ ---
        // å–å¾— ID ä¸¦ç¢ºä¿å®ƒæ˜¯å­—ä¸²
        const rawEditId = document.getElementById('edit-id').value;
        const editId = rawEditId ? String(rawEditId) : null;

        // å˜—è©¦åœ¨ç¾æœ‰è³‡æ–™ä¸­å°‹æ‰¾ (æ¯”å°æ™‚å…©é‚Šéƒ½ç¢ºä¿æ˜¯å­—ä¸²)
        const existingIndex = editId ? STATE.expenses.findIndex(x => String(x.id) === editId) : -1;
        
        // ç‚ºäº†ä¿ç•™é‚„æ¬¾ç´€éŒ„ (repayments)ï¼Œå¦‚æœæ˜¯åœ¨ç·¨è¼¯ï¼Œè¦å…ˆæ’ˆå‡ºèˆŠçš„ repayments
        let oldRepayments = [];
        if (existingIndex !== -1) {
            oldRepayments = STATE.expenses[existingIndex].repayments || [];
        }

        const newData = {
            id: editId || Date.now().toString(),
            date: document.getElementById('date').value,
            amount: amount,
            currency: document.getElementById('currency').value,
            category: document.getElementById('category').value,
            merchant: document.getElementById('merchant').value,
            remark: document.getElementById('remark').value,
            paymentMethod: document.getElementById('payment-method').value,
            payer: document.querySelector('input[name="payer"]:checked').value,
            consumers: consumers,
            splitDetails: splitDetails,
            repayments: oldRepayments // ç¹¼æ‰¿èˆŠè³‡æ–™
        };

        if (existingIndex !== -1) {
            // æ‰¾åˆ°äº†ï¼åŸ·è¡Œæ›´æ–° (æ”¹å¯«)
            STATE.expenses[existingIndex] = newData;
        } else {
            // æ²’æ‰¾åˆ°ï¼ŒåŸ·è¡Œæ–°å¢
            STATE.expenses.push(newData);
        }
        // --- æ ¸å¿ƒä¿®æ­£çµæŸ ---
        
        switchView('home');
        saveRemoteData('save');
        resetForm();
    }

    function editExpense(id) {
        const exp = STATE.expenses.find(e => e.id === id);
        if(!exp) return;
        
        resetForm();
        document.getElementById('edit-id').value = id;
        document.getElementById('form-title').innerText = "ç·¨è¼¯æ¶ˆè²»";
        document.getElementById('submit-btn-text').innerText = "æ›´æ–°ç´€éŒ„";
        document.getElementById('btn-delete-expense').classList.remove('hidden');
        document.getElementById('amount').value = exp.amount;
        document.getElementById('currency').value = exp.currency;
        document.getElementById('date').value = exp.date; // é€™è£¡çš„ date å·²ç¶“è¢« loadRemoteData æ¸…æ´—éï¼Œæ ¼å¼æ­£ç¢º
        document.getElementById('merchant').value = exp.merchant;
        document.getElementById('remark').value = exp.remark;
        document.getElementById('category').value = exp.category;
        document.getElementById('payment-method').value = exp.paymentMethod;
        
        const payerRadio = document.querySelector(`input[name="payer"][value="${exp.payer}"]`);
        if(payerRadio) payerRadio.checked = true;

        if (exp.splitDetails && Object.keys(exp.splitDetails).length > 0) {
            setSplitMode('custom');
            setTimeout(() => { document.querySelectorAll('.custom-split-input').forEach(inp => { inp.value = exp.splitDetails[inp.dataset.member] || 0; }); }, 50);
        } else {
            setSplitMode('equal');
            setTimeout(() => { document.querySelectorAll('input[name="consumer_cb"]').forEach(cb => { cb.checked = exp.consumers.includes(cb.value); }); }, 50);
        }
        switchView('add');
    }

    function deleteCurrentExpense() {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        const id = document.getElementById('edit-id').value;
        STATE.expenses = STATE.expenses.filter(e => e.id !== id);
        switchView('home');
        saveRemoteData('save');
    }

    function setSplitCurrency(c) {
        STATE.splitCurrency = c;
        document.getElementById('tab-gbp').className = c==='GBP' ? "flex-1 py-2 rounded-lg text-sm font-bold shadow-sm bg-white text-indigo-600" : "flex-1 py-2 rounded-lg text-sm font-bold text-gray-500";
        document.getElementById('tab-hkd').className = c==='HKD' ? "flex-1 py-2 rounded-lg text-sm font-bold shadow-sm bg-white text-pink-600" : "flex-1 py-2 rounded-lg text-sm font-bold text-gray-500";
        renderSplit();
    }

    function renderSplit() {
        const list = document.getElementById('settlement-list');
        const debts = calculateDebts(STATE.splitCurrency);
        list.innerHTML = '';
        if (debts.length === 0) list.innerHTML = `<div class="bg-green-50 text-green-600 p-4 rounded-xl text-center font-bold">ç›®å‰ç„¡é ˆçµç®—</div>`;
        debts.forEach(d => {
            const sym = STATE.splitCurrency==='GBP'?'Â£':'$';
            list.innerHTML += `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-gray-700 font-bold">${d.from} <i class="fas fa-arrow-right text-gray-300 text-sm"></i> ${d.to}</div>
                    <div class="flex items-center gap-2"><span class="text-xl font-bold text-gray-800">${sym}${d.amount.toFixed(2)}</span><button onclick="confirmRepayment('${d.from}','${d.to}',${d.amount})" class="bg-gray-800 text-white text-xs px-3 py-2 rounded-lg active:scale-95 transition">é‚„æ¬¾</button></div>
                </div>`;
        });
        
        const histEl = document.getElementById('history-list');
        histEl.innerHTML = '';
        STATE.settlements.filter(s => s.currency === STATE.splitCurrency).sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(s => {
             const sym = STATE.splitCurrency==='GBP'?'Â£':'$';
             histEl.innerHTML += `
                <div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer" onclick="showSettlementDetail('${s.id}')">
                    <div><div class="text-sm font-bold text-gray-700">${s.from} <i class="fas fa-check text-green-500 mx-1"></i> ${s.to}</div><div class="text-xs text-gray-400">${new Date(s.date).toLocaleDateString()} Â· ${s.method||'æœªå‚™è¨»'}</div></div>
                    <span class="font-bold text-gray-600">${sym}${s.totalAmount.toLocaleString()}</span>
                </div>`;
        });
    }

    function calculateDebts(curr) {
        let matrix = {};
        STATE.members.forEach(m => matrix[m] = {});
        STATE.expenses.filter(e => e.currency === curr && getExpenseStatus(e) !== 'settled').forEach(exp => {
            const payer = exp.payer;
            STATE.members.forEach(consumer => {
                if (consumer === payer) return;
                let shouldPay = 0;
                if (Object.keys(exp.splitDetails).length > 0) shouldPay = exp.splitDetails[consumer] || 0;
                else if (exp.consumers.includes(consumer)) shouldPay = exp.amount / exp.consumers.length;
                const repaid = exp.repayments.filter(r => r.from === consumer).reduce((a,b)=>a+b.amount,0);
                const debt = shouldPay - repaid;
                if (debt > 0.05) matrix[consumer][payer] = (matrix[consumer][payer] || 0) + debt;
            });
        });
        let result = [];
        STATE.members.forEach(i => {
            STATE.members.forEach(j => {
                if(i===j) return;
                let i_j = matrix[i][j] || 0;
                let j_i = matrix[j][i] || 0;
                if(i_j > j_i) { result.push({ from: i, to: j, amount: i_j - j_i }); matrix[i][j] -= j_i; matrix[j][i] = 0; }
            });
        });
        return result.filter(r => r.amount > 0.05);
    }

    function confirmRepayment(from, to, amount) {
        const method = prompt(`è«‹è¼¸å…¥é‚„æ¬¾æ–¹å¼å‚™è¨» (ä¾‹å¦‚: éæ•¸, ç¾é‡‘):`, "éæ•¸");
        if (method === null) return;
        const settleId = Date.now().toString();
        let remaining = amount;
        let involved = [];
        const candidates = STATE.expenses.filter(e => e.currency === STATE.splitCurrency && getExpenseStatus(e) !== 'settled' && e.payer === to).sort((a,b) => new Date(a.date) - new Date(b.date));

        for (let exp of candidates) {
            if (remaining <= 0.01) break;
            let debt = 0;
            if (Object.keys(exp.splitDetails).length > 0) debt = exp.splitDetails[from] || 0;
            else if (exp.consumers.includes(from)) debt = exp.amount / exp.consumers.length;
            const repaid = exp.repayments.filter(r => r.from === from).reduce((s,r)=>s+r.amount,0);
            const realDebt = debt - repaid;
            if (realDebt > 0.01) {
                const pay = Math.min(remaining, realDebt);
                exp.repayments.push({ from: from, amount: pay, date: new Date().toISOString(), settleId: settleId });
                involved.push(exp.id);
                remaining -= pay;
            }
        }
        STATE.settlements.push({ id: settleId, date: new Date().toISOString(), currency: STATE.splitCurrency, totalAmount: amount, from: from, to: to, method: method, involvedExpenses: involved });
        
        renderSplit(); 
        renderHome();
        saveRemoteData('save');
    }

    function showSettlementDetail(id) {
        const s = STATE.settlements.find(x => x.id === id);
        const content = document.getElementById('settlement-detail-content');
        const sym = s.currency==='GBP'?'Â£':'$';
        content.innerHTML = `
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl"><h3 class="font-bold">çµç®—è©³æƒ…</h3><button onclick="document.getElementById('modal-settlement-detail').classList.remove('active')" class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-gray-500"><i class="fas fa-times"></i></button></div>
            <div class="p-6 text-center"><div class="text-3xl font-bold text-gray-800 mb-1">${sym}${s.totalAmount}</div><div class="text-sm text-gray-500">${s.from} <i class="fas fa-arrow-right"></i> ${s.to}</div><div class="inline-block bg-gray-100 px-3 py-1 rounded-full text-xs text-gray-600 mt-2">${s.method}</div></div>
            <div class="flex-1 overflow-y-auto px-4 pb-4"><h4 class="text-xs font-bold text-gray-400 mb-2">åŒ…å«æ¶ˆè²»é …ç›®</h4>
                 ${s.involvedExpenses.map(eid => {
                     const exp = STATE.expenses.find(e=>e.id===eid);
                     if(!exp) return '';
                     const rep = exp.repayments.find(r=>r.settleId === id);
                     return `<div class="flex justify-between py-2 border-b border-gray-100 text-sm"><span>${exp.merchant||'æœªå‘½å'} (${exp.date.substring(5)})</span><span class="font-bold">${sym}${rep.amount.toFixed(2)}</span></div>`;
                 }).join('')}
            </div>
            <div class="p-4 border-t border-gray-100"><button onclick="undoSettlement('${id}')" class="w-full text-red-500 border border-red-200 py-3 rounded-xl font-bold">é‚„åŸæ­¤çµç®— (Undo)</button></div>
        `;
        document.getElementById('modal-settlement-detail').classList.add('active');
    }

    function undoSettlement(id) {
        if(!confirm("é‚„åŸå¾Œï¼Œç›¸é—œå‚µå‹™å°‡é‡æ–°è®Šå›ã€Œæœªçµç®—ã€ã€‚ç¢ºå®šï¼Ÿ")) return;
        STATE.expenses.forEach(e => { e.repayments = e.repayments.filter(r => r.settleId !== id); });
        STATE.settlements = STATE.settlements.filter(s => s.id !== id);
        document.getElementById('modal-settlement-detail').classList.remove('active'); 
        renderSplit(); 
        renderHome();
        saveRemoteData('save');
    }

    function openSettings() { document.getElementById('modal-settings').classList.add('active'); renderSettingsList(); }
    function closeSettings() { document.getElementById('modal-settings').classList.remove('active'); renderDropdowns(); renderHome(); }
    function openBackup() { document.getElementById('modal-backup').classList.add('active'); }
    function openFilterModal() {
        document.getElementById('modal-filter').classList.add('active');
        const memSelect = document.getElementById('filter-member-select');
        memSelect.innerHTML = `<option value="">å…¨éƒ¨æˆå“¡</option>` + STATE.members.map(m => `<option value="${m}" ${STATE.filters.member===m?'selected':''}>${m}</option>`).join('');
        document.getElementById('filter-categories').innerHTML = STATE.categories.map(c => `<label class="flex items-center gap-1 bg-gray-50 p-2 rounded text-xs cursor-pointer"><input type="checkbox" value="${c.id}" ${STATE.filters.categories.includes(c.id)?'checked':''}> ${c.icon} ${c.label}</label>`).join('');
        document.getElementById('filter-status').value = STATE.filters.status; document.getElementById('filter-currency').value = STATE.filters.currency; document.getElementById('filter-start').value = STATE.filters.start; document.getElementById('filter-end').value = STATE.filters.end;
    }
    function closeFilterModal() { document.getElementById('modal-filter').classList.remove('active'); }
    function applyFilters() {
        STATE.filters.status = document.getElementById('filter-status').value;
        STATE.filters.currency = document.getElementById('filter-currency').value;
        STATE.filters.start = document.getElementById('filter-start').value;
        STATE.filters.end = document.getElementById('filter-end').value;
        STATE.filters.member = document.getElementById('filter-member-select').value;
        STATE.filters.categories = Array.from(document.querySelectorAll('#filter-categories input:checked')).map(c=>c.value);
        closeFilterModal(); renderHome();
    }
    function resetFilters() { STATE.filters = { start: '', end: '', status: 'unsettled', currency: 'all', member: '', categories: [] }; closeFilterModal(); renderHome(); }
    
    function renderSettingsList() {
        document.getElementById('settings-members').innerHTML = STATE.members.map(m => `<div class="flex gap-2 items-center"><input type="text" value="${m}" class="input-style flex-1 px-2 py-2 text-sm rounded min-w-0" onchange="updateMemberName('${m}', this.value)">${STATE.members.length > 1 ? `<button onclick="removeMember('${m}')" class="text-red-400 p-2 shrink-0"><i class="fas fa-trash"></i></button>` : ''}</div>`).join('');
        document.getElementById('settings-methods').innerHTML = STATE.methods.map(m => `<div class="flex gap-2 items-center"><input type="text" value="${m}" class="input-style flex-1 px-2 py-2 text-sm rounded min-w-0" onchange="updateMethodName('${m}', this.value)"><button onclick="removeMethod('${m}')" class="text-red-400 p-2 shrink-0"><i class="fas fa-trash"></i></button></div>`).join('');
        document.getElementById('settings-categories').innerHTML = STATE.categories.map(c => `<div class="flex gap-2 items-center"><input type="text" value="${c.icon}" class="input-style w-10 text-center px-1 py-2 rounded text-sm shrink-0" onchange="updateCategory('${c.id}', 'icon', this.value)"><input type="text" value="${c.label}" class="input-style flex-1 px-2 py-2 text-sm rounded min-w-0" onchange="updateCategory('${c.id}', 'label', this.value)"><button onclick="removeCategory('${c.id}')" class="text-red-400 p-2 shrink-0"><i class="fas fa-trash"></i></button></div>`).join('');
    }
    
    function updateMemberName(o, n) { if (!n || n===o) return; const i = STATE.members.indexOf(o); STATE.members[i] = n; updateReferences(o, n); saveRemoteData('save'); }
    function updateReferences(oldName, newName) {
        STATE.expenses.forEach(e => {
            if (e.payer === oldName) e.payer = newName;
            if (e.consumers.includes(oldName)) e.consumers[e.consumers.indexOf(oldName)] = newName;
            if (e.splitDetails && e.splitDetails[oldName] !== undefined) { e.splitDetails[newName] = e.splitDetails[oldName]; delete e.splitDetails[oldName]; }
            e.repayments.forEach(r => { if(r.from === oldName) r.from = newName; });
        });
        STATE.settlements.forEach(s => { if(s.from === oldName) s.from = newName; if(s.to === oldName) s.to = newName; });
    }
    function addMember() { const val = document.getElementById('new-member-name').value; if(val && !STATE.members.includes(val)) { STATE.members.push(val); saveRemoteData('save'); renderSettingsList(); document.getElementById('new-member-name').value=''; } }
    function removeMember(name) { if(!confirm("ç¢ºå®šåˆªé™¤æˆå“¡ï¼Ÿ")) return; STATE.members = STATE.members.filter(m => m !== name); saveRemoteData('save'); renderSettingsList(); }
    function updateMethodName(o, n) { if (!n || n===o) return; STATE.methods[STATE.methods.indexOf(o)] = n; STATE.expenses.forEach(e => { if(e.paymentMethod === o) e.paymentMethod = n; }); saveRemoteData('save'); }
    function addPaymentMethod() { const val = document.getElementById('new-method-name').value; if(val) { STATE.methods.push(val); saveRemoteData('save'); renderSettingsList(); document.getElementById('new-method-name').value=''; } }
    function removeMethod(val) { STATE.methods = STATE.methods.filter(m => m !== val); saveRemoteData('save'); renderSettingsList(); }
    function updateCategory(id, f, v) { const cat = STATE.categories.find(c => c.id === id); if(cat) { cat[f] = v; saveRemoteData('save'); } }
    function addCategory() { const name = document.getElementById('new-cat-name').value; if(name) { STATE.categories.push({ id: 'cat_'+Date.now(), label: name, icon: document.getElementById('new-cat-icon').value||'ğŸ·ï¸', color: 'bg-gray-100 text-gray-500' }); saveRemoteData('save'); renderSettingsList(); document.getElementById('new-cat-name').value=''; } }
    function removeCategory(id) { STATE.categories = STATE.categories.filter(c => c.id !== id); saveRemoteData('save'); renderSettingsList(); }
    function clearAllData() { if(confirm("è­¦å‘Šï¼šå°‡åˆªé™¤æ‰€æœ‰é›²ç«¯è³‡æ–™ï¼")) { STATE.expenses=[]; STATE.settlements=[]; saveRemoteData('save'); renderSettingsList(); } }
    
    function handleMerchantInput(input) {
         const val = input.value.toLowerCase();
         const box = document.getElementById('merchant-suggestions');
         if (!val) { box.classList.add('hidden'); return; }
         const matches = [...new Set(STATE.expenses.map(e => e.merchant).filter(m => m))].filter(m => m.toLowerCase().includes(val)).slice(0, 5);
         if (matches.length > 0) {
             box.innerHTML = matches.map(m => `<div class="px-4 py-3 border-b border-gray-50 hover:bg-gray-50 cursor-pointer text-sm text-gray-600" onclick="document.getElementById('merchant').value='${m}';this.parentElement.classList.add('hidden')">${m}</div>`).join('');
             box.classList.remove('hidden');
         } else box.classList.add('hidden');
    }
</script>
</body>
</html>